<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Code Collab - Real-time Collaborative Editor</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Simple scrollbar styling */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #2d3748;
        }
        ::-webkit-scrollbar-thumb {
            background: #4a5568;
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #718096;
        }
        .code-editor {
            font-family: 'Courier New', Courier, monospace;
            tab-size: 4;
            -moz-tab-size: 4;
            -o-tab-size: 4;
        }
        /* Console message styling */
        .console-log { color: #e5e7eb; }
        .console-error { color: #f87171; }
        .console-warn { color: #facc15; }
        .console-info { color: #60a5fa; }
    </style>
</head>
<body class="bg-gray-900 text-white font-sans antialiased">

    <div id="notification" class="hidden fixed top-5 right-5 bg-red-500 text-white py-2 px-4 rounded-lg shadow-lg z-50 transition-opacity duration-300"></div>

    <!-- App Container -->
    <div id="app" class="min-h-screen flex flex-col">

        <!-- Home View -->
        <div id="home-view" class="flex-grow flex items-center justify-center p-4">
            <div class="w-full max-w-md bg-gray-800 rounded-2xl shadow-lg p-8 space-y-8">
                <div>
                    <h1 class="text-4xl font-bold text-center text-indigo-400">Code Collab</h1>
                    <p class="text-center text-gray-400 mt-2">Pair program in real-time.</p>
                </div>

                <!-- Create Room -->
                <button id="create-room-btn" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-4 rounded-lg transition duration-300 focus:outline-none focus:ring-2 focus:ring-indigo-500">
                    Create New Room
                </button>

                <div class="relative">
                    <div class="absolute inset-0 flex items-center">
                        <div class="w-full border-t border-gray-600"></div>
                    </div>
                    <div class="relative flex justify-center text-sm">
                        <span class="px-2 bg-gray-800 text-gray-400">Or Join a Room</span>
                    </div>
                </div>

                <!-- Join Room -->
                <div class="space-y-4">
                    <input type="text" id="room-id-input" placeholder="Enter Room ID" class="w-full bg-gray-700 border border-gray-600 text-white px-4 py-3 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500">
                    <button id="join-room-btn" class="w-full bg-gray-600 hover:bg-gray-700 text-white font-bold py-3 px-4 rounded-lg transition duration-300 focus:outline-none focus:ring-2 focus:ring-gray-500">
                        Join Room
                    </button>
                </div>

                <!-- Social Links -->
                <div class="flex flex-col sm:flex-row items-center justify-center gap-4 pt-4 border-t border-gray-700">
                    <a href="https://github.com/Abhay557/Code-Collab" target="_blank" rel="noopener noreferrer" class="w-full sm:w-auto flex items-center justify-center gap-2 text-white bg-gray-700 hover:bg-gray-600 font-semibold py-2 px-4 rounded-lg transition-colors duration-300">
                        <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24" aria-hidden="true"><path fill-rule="evenodd" d="M12 2C6.477 2 2 6.477 2 12c0 4.418 2.865 8.168 6.839 9.492.5.092.682-.217.682-.482 0-.237-.009-.868-.014-1.703-2.782.605-3.369-1.343-3.369-1.343-.454-1.158-1.11-1.466-1.11-1.466-.908-.62.069-.608.069-.608 1.003.07 1.531 1.032 1.531 1.032.892 1.53 2.341 1.088 2.91.832.092-.647.35-1.088.636-1.338-2.22-.253-4.555-1.113-4.555-4.951 0-1.093.39-1.988 1.031-2.688-.103-.253-.446-1.272.098-2.65 0 0 .84-.27 2.75 1.026A9.564 9.564 0 0112 6.844c.85.004 1.705.115 2.504.337 1.909-1.296 2.747-1.027 2.747-1.027.546 1.379.203 2.398.1 2.651.64.7 1.03 1.595 1.03 2.688 0 3.848-2.338 4.695-4.566 4.942.359.308.678.92.678 1.855 0 1.338-.012 2.419-.012 2.747 0 .268.18.58.688.482A10.001 10.001 0 0022 12c0-5.523-4.477-10-10-10z" clip-rule="evenodd" /></svg>
                        GitHub
                    </a>
                    <a href="https://discord.gg/f2vvuz3ZEw" target="_blank" rel="noopener noreferrer" class="w-full sm:w-auto flex items-center justify-center gap-2 text-white bg-gray-700 hover:bg-gray-600 font-semibold py-2 px-4 rounded-lg transition-colors duration-300">
                        <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 16 16" aria-hidden="true">
                            <path d="M13.545 2.907a13.227 13.227 0 0 0-3.257-1.011.05.05 0 0 0-.052.025c-.141.25-.297.577-.406.833a12.19 12.19 0 0 0-3.658 0 8.258 8.258 0 0 0-.412-.833.051.051 0 0 0-.052-.025c-1.125.194-2.22.534-3.257 1.011a.041.041 0 0 0-.021.018C.356 6.024-.213 9.047.066 12.032c.001.014.01.028.021.037a13.276 13.276 0 0 0 3.995 2.02.05.05 0 0 0 .056-.019c.308-.42.582-.863.818-1.329a.05.05 0 0 0-.01-.059.051.051 0 0 0-.018-.011 8.875 8.875 0 0 1-1.248-.595.05.05 0 0 1-.02-.066.051.051 0 0 1 .015-.019c.084-.063.168-.129.248-.195a.05.05 0 0 1 .051-.007c2.619 1.165 5.48 1.165 8.1 0a.05.05 0 0 1 .053.007c.08.066.164.132.248.195a.051.051 0 0 1 .015.019.05.05 0 0 1-.02.066 8.875 8.875 0 0 1-1.248.595.05.05 0 0 0-.01.059c.236.466.51.899.818 1.329a.05.05 0 0 0 .056.019 13.235 13.235 0 0 0 4.001-2.02.049.049 0 0 0 .021-.037c.276-2.986-.42-6.008-1.99-9.125a.043.043 0 0 0-.02-.019Zm-8.198 7.307c-.789 0-1.438-.724-1.438-1.612 0-.889.637-1.613 1.438-1.613.807 0 1.45.73 1.438 1.613 0 .888-.637 1.612-1.438 1.612Zm5.316 0c-.788 0-1.438-.724-1.438-1.612 0-.889.637-1.613 1.438-1.613.807 0 1.451.73 1.438 1.613 0 .888-.631 1.612-1.438 1.612Z"/>
                        </svg>
                        Discord
                    </a>
                </div>

            </div>
        </div>

        <!-- Editor View (Initially Hidden) -->
        <div id="editor-view" class="hidden flex-grow flex flex-col h-screen">
            <!-- Header -->
            <header class="bg-gray-800 p-3 flex items-center justify-between shadow-md z-10 flex-shrink-0">
                <div class="flex items-center gap-4">
                    <h1 class="text-2xl font-bold text-indigo-400">Code Collab</h1>
                    <div class="text-gray-400">
                        <span class="font-mono bg-gray-700 px-3 py-1 rounded-md text-sm">
                            Room ID: <span id="room-id-display" class="font-bold text-indigo-300"></span>
                        </span>
                    </div>
                </div>
                <div class="flex items-center gap-4">
                    <div class="flex items-center gap-2 text-sm" title="Participants">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-gray-400" viewBox="0 0 20 20" fill="currentColor">
                            <path d="M9 6a3 3 0 11-6 0 3 3 0 016 0zM17 6a3 3 0 11-6 0 3 3 0 016 0zM12.93 17c.046-.327.07-.66.07-1a6.97 6.97 0 00-1.5-4.33A5 5 0 0119 16v1h-6.07zM6 11a5 5 0 015 5v1H1v-1a5 5 0 015-5z" />
                        </svg>
                        <span id="participants-count" class="font-bold text-gray-200">0</span>
                    </div>
                    <div id="participants-list" class="flex items-center gap-2 text-sm text-gray-300"></div>
                    <button id="leave-room-btn" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg transition duration-300 text-sm">
                        Leave Room
                    </button>
                </div>
            </header>

            <!-- Main Content: Editor Panels + Output -->
            <div class="flex-grow flex flex-row gap-2 p-2 overflow-hidden">
                <!-- Left Panel: Editors + Console (50% width) -->
                <div class="w-1/2 flex flex-col gap-2">

                    <!-- HTML Section (25% height) -->
                    <div class="flex flex-col bg-gray-800 rounded-lg overflow-hidden flex-1">
                        <div class="bg-gray-900 px-4 py-2 text-sm font-semibold text-gray-300 flex-shrink-0">
                            <span>HTML</span>
                        </div>
                        <textarea id="html-editor" class="code-editor w-full flex-grow p-2 bg-gray-800 text-white resize-none focus:outline-none" spellcheck="false"></textarea>
                    </div>

                    <!-- CSS Section (25% height) -->
                    <div class="flex flex-col bg-gray-800 rounded-lg overflow-hidden flex-1">
                        <div class="bg-gray-900 px-4 py-2 text-sm font-semibold text-gray-300 flex-shrink-0">
                            <span>CSS</span>
                        </div>
                        <textarea id="css-editor" class="code-editor w-full flex-grow p-2 bg-gray-800 text-white resize-none focus:outline-none" spellcheck="false"></textarea>
                    </div>

                    <!-- JavaScript Section (25% height) -->
                    <div class="flex flex-col bg-gray-800 rounded-lg overflow-hidden flex-1">
                        <div class="bg-gray-900 px-4 py-2 text-sm font-semibold text-gray-300 flex-shrink-0">
                            <span>JavaScript</span>
                        </div>
                        <textarea id="js-editor" class="code-editor w-full flex-grow p-2 bg-gray-800 text-white resize-none focus:outline-none" spellcheck="false"></textarea>
                    </div>

                    <!-- Console Output (25% height) -->
                    <div class="flex flex-col bg-gray-800 rounded-lg overflow-hidden flex-1">
                        <div class="bg-gray-900 px-4 py-2 text-sm font-semibold text-gray-300 flex justify-between items-center w-full flex-shrink-0">
                            <span>Console</span>
                            <button id="clear-console-btn" class="text-xs bg-gray-700 hover:bg-gray-600 px-2 py-1 rounded">Clear</button>
                        </div>
                        <div id="console-output" class="p-2 overflow-y-auto text-sm font-mono space-y-1 w-full flex-grow"></div>
                    </div>

                </div>

                <!-- Right Panel: Output (50% width) -->
                <div class="w-1/2 bg-white rounded-lg overflow-hidden">
                    <iframe id="output-frame" class="w-full h-full border-0"></iframe>
                </div>
            </div>
        </div>
    </div>

    <!-- Custom Modal for Name Input -->
    <div id="name-modal" class="hidden fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50">
        <div class="bg-gray-800 rounded-2xl shadow-lg p-8 w-full max-w-sm space-y-4">
            <h2 id="modal-title" class="text-2xl font-bold text-center">Enter Your Name</h2>
            <input type="text" id="name-input" placeholder="Your Name" class="w-full bg-gray-700 border border-gray-600 text-white px-4 py-3 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500">
            <div class="flex gap-4">
                <button id="modal-cancel" class="w-full bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-lg transition duration-300">Cancel</button>
                <button id="modal-confirm" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-lg transition duration-300">Confirm</button>
            </div>
        </div>
    </div>

    <script type="module">
        // Firebase SDK imports
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, updateDoc, onSnapshot, arrayUnion, arrayRemove, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    const firebaseConfig = {
  apiKey: "AIzaSyCP_g01qPZJl7__le9G8ENwjQQTV0FqGy0",
  authDomain: "login-system-339d5.firebaseapp.com",
  databaseURL: "https://login-system-339d5-default-rtdb.firebaseio.com",
  projectId: "login-system-339d5",
  storageBucket: "login-system-339d5.firebasestorage.app",
  messagingSenderId: "744363872803",
  appId: "1:744363872803:web:4f961da9125c3d5afdd796",
  measurementId: "G-NC3JF4KD2P"
};

const appId = 'default-collab-editor'; // You can leave this as is.
        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // DOM Elements
        const homeView = document.getElementById('home-view');
        const editorView = document.getElementById('editor-view');
        const createRoomBtn = document.getElementById('create-room-btn');
        const joinRoomBtn = document.getElementById('join-room-btn');
        const roomIdInput = document.getElementById('room-id-input');
        const roomIdDisplay = document.getElementById('room-id-display');
        const participantsList = document.getElementById('participants-list');
        const participantsCount = document.getElementById('participants-count');
        const leaveRoomBtn = document.getElementById('leave-room-btn');
        
        const htmlEditor = document.getElementById('html-editor');
        const cssEditor = document.getElementById('css-editor');
        const jsEditor = document.getElementById('js-editor');
        const outputFrame = document.getElementById('output-frame');
        const notification = document.getElementById('notification');
        const consoleOutput = document.getElementById('console-output');
        const clearConsoleBtn = document.getElementById('clear-console-btn');

        // Modal Elements
        const nameModal = document.getElementById('name-modal');
        const modalTitle = document.getElementById('modal-title');
        const nameInput = document.getElementById('name-input');
        const modalConfirm = document.getElementById('modal-confirm');
        const modalCancel = document.getElementById('modal-cancel');
        
        // App State
        let currentUser = null;
        let currentRoomId = null;
        let unsubscribeRoom = null; // To stop listening to room updates
        let localUser = null; // { uid, name }
        let debounceTimer;

        // --- AUTHENTICATION ---
        onAuthStateChanged(auth, (user) => {
            if (user) {
                currentUser = user;
                initializeAppLogic();
            } else {
                 // If auth state changes to null, it means sign-in failed or is pending.
                 // We can re-attempt or handle it gracefully.
                 signIn(); 
            }
        });
        
        async function signIn() {
            if (auth.currentUser) return; // Already signed in
            try {
                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                     await signInWithCustomToken(auth, __initial_auth_token);
                } else {
                    await signInAnonymously(auth);
                }
            } catch (error) {
                 console.error("Authentication failed:", error);
                 showNotification("Could not connect to the service. Please refresh the page.");
            }
        }


        // --- UI & VIEW MANAGEMENT ---
        function showView(view) {
            homeView.classList.add('hidden');
            editorView.classList.add('hidden');
            if (view === 'home') {
                homeView.classList.remove('hidden');
            } else if (view === 'editor') {
                editorView.classList.remove('hidden');
            }
        }

        function showNotification(message, type = 'error', duration = 3000) {
            notification.textContent = message;
            notification.classList.remove('bg-red-500', 'bg-green-500', 'bg-blue-500');
            if (type === 'error') notification.classList.add('bg-red-500');
            else if (type === 'info') notification.classList.add('bg-blue-500');
            else notification.classList.add('bg-green-500');
            notification.classList.remove('hidden');
            setTimeout(() => { notification.classList.add('hidden'); }, duration);
        }

        function askForName(title) {
            return new Promise((resolve) => {
                modalTitle.textContent = title;
                nameInput.value = '';
                nameModal.classList.remove('hidden');
                
                const onConfirm = () => { if (nameInput.value.trim()) { cleanup(); resolve(nameInput.value.trim()); } };
                const onCancel = () => { cleanup(); resolve(null); };
                const onKeypress = (e) => { if (e.key === 'Enter') onConfirm(); }

                const cleanup = () => {
                    nameModal.classList.add('hidden');
                    modalConfirm.removeEventListener('click', onConfirm);
                    modalCancel.removeEventListener('click', onCancel);
                    nameInput.removeEventListener('keypress', onKeypress);
                };

                modalConfirm.addEventListener('click', onConfirm);
                modalCancel.addEventListener('click', onCancel);
                nameInput.addEventListener('keypress', onKeypress);
                nameInput.focus();
            });
        }

        // --- CORE APP LOGIC ---
        function initializeAppLogic() {
            const roomIdFromHash = window.location.hash.substring(1);
            if (roomIdFromHash) handleJoinRoom(roomIdFromHash);
            else showView('home');
            
            window.addEventListener('hashchange', () => {
                 const newRoomId = window.location.hash.substring(1);
                 if (!newRoomId) leaveRoom();
            });
        }
        
        createRoomBtn.addEventListener('click', async () => {
            if (!currentUser) {
                showNotification("Still connecting... Please try again in a moment.");
                return;
            }
            const name = await askForName('Enter Your Name to Create a Room');
            if (!name) return;
            
            localUser = { uid: currentUser.uid, name: name };
            const newRoomId = Math.random().toString(36).substring(2, 9);
            const roomRef = doc(db, `artifacts/${appId}/public/data/rooms`, newRoomId);

            try {
                await setDoc(roomRef, {
                    html: '<h1>Hello, World!</h1>\n<p>Start coding and see the output here.</p>\n<button onclick="logSomething()">Click Me</button>',
                    css: 'body { font-family: sans-serif; text-align: center; padding-top: 20px; }\nbutton { padding: 8px 16px; }',
                    js: 'function logSomething() {\n  console.log("Button was clicked!");\n  console.warn("This is a warning.");\n  console.error("This is an error.");\n}',
                    participants: [localUser],
                    createdAt: serverTimestamp()
                });
                window.location.hash = newRoomId;
                enterEditor(newRoomId, roomRef);
            } catch (error) {
                console.error("Error creating room: ", error);
                showNotification("Could not create room. Please try again.");
            }
        });

        joinRoomBtn.addEventListener('click', () => {
            const roomId = roomIdInput.value.trim();
            if (roomId) handleJoinRoom(roomId);
            else showNotification("Please enter a Room ID.");
        });

        async function handleJoinRoom(roomId) {
             if (!currentUser) {
                 showNotification("Still connecting... Please try again in a moment.");
                 return;
            }
             const roomRef = doc(db, `artifacts/${appId}/public/data/rooms`, roomId);
             try {
                 const roomSnap = await getDoc(roomRef);

                 if (!roomSnap.exists()) {
                     showNotification("Room not found!");
                     window.location.hash = '';
                     return;
                 }
                 
                 const roomData = roomSnap.data();
                 const isAlreadyIn = roomData.participants.some(p => p.uid === currentUser.uid);

                 if (roomData.participants.length >= 6 && !isAlreadyIn) {
                     showNotification("This room is full.");
                     window.location.hash = '';
                     return;
                 }
                 
                 const name = await askForName('Enter Your Name to Join');
                 if (!name) { window.location.hash = ''; return; }

                 localUser = { uid: currentUser.uid, name: name };
                 
                 if (!isAlreadyIn) {
                     await updateDoc(roomRef, { participants: arrayUnion(localUser) });
                 }
                 
                 window.location.hash = roomId;
                 enterEditor(roomId, roomRef);

             } catch (error) {
                  console.error("Error joining room:", error);
                  showNotification("Could not join the room.");
                  window.location.hash = '';
             }
        }

        function enterEditor(roomId, roomRef) {
            currentRoomId = roomId;
            showView('editor');
            roomIdDisplay.textContent = roomId;

            htmlEditor.addEventListener('input', handleCodeChange);
            cssEditor.addEventListener('input', handleCodeChange);
            jsEditor.addEventListener('input', handleCodeChange);
            
            unsubscribeRoom = onSnapshot(roomRef, (docSnap) => {
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    if (document.activeElement !== htmlEditor) htmlEditor.value = data.html;
                    if (document.activeElement !== cssEditor) cssEditor.value = data.css;
                    if (document.activeElement !== jsEditor) jsEditor.value = data.js;
                    updateIframe();
                    updateParticipants(data.participants);
                } else {
                    showNotification("The room you were in has been closed.", "info");
                    leaveRoom();
                }
            }, (error) => {
                console.error("Snapshot listener error:", error);
                showNotification("Connection to room lost. Please refresh.");
                leaveRoom();
            });

            window.addEventListener('message', handleConsoleMessage);
            window.addEventListener('beforeunload', handleBeforeUnload);
            leaveRoomBtn.addEventListener('click', leaveRoom);
            clearConsoleBtn.addEventListener('click', () => { consoleOutput.innerHTML = ''; });
        }
        
        function handleCodeChange() {
            clearTimeout(debounceTimer);
            debounceTimer = setTimeout(() => {
                if (currentRoomId) {
                    const roomRef = doc(db, `artifacts/${appId}/public/data/rooms`, currentRoomId);
                    updateDoc(roomRef, {
                        html: htmlEditor.value,
                        css: cssEditor.value,
                        js: jsEditor.value,
                    });
                }
            }, 500);
        }

        function updateIframe() {
             const consoleScript = `<script>const formatArg=(arg)=>{if(arg instanceof Error){return arg.stack||arg.message}if(typeof arg==='object'&&arg!==null){try{return JSON.stringify(arg)}catch(e){return'[Unserializable Object]'}}return String(arg)};const overrideConsole=(method,type)=>{const original=console[method];console[method]=(...args)=>{window.parent.postMessage({source:'iframe-console',type:type,message:args.map(formatArg).join(' ')},'*');original.apply(console,args)}};overrideConsole('log','log');overrideConsole('error','error');overrideConsole('warn','warn');overrideConsole('info','info');window.addEventListener('error',(e)=>{window.parent.postMessage({source:'iframe-console',type:'error',message:e.message},'*')});<\/script>`;
             const iframeContent = `<html><head><style>${cssEditor.value}<\/style>${consoleScript}<\/head><body>${htmlEditor.value}<script>try {${jsEditor.value}} catch (e) {console.error(e);}<\/script><\/body><\/html>`;
             outputFrame.srcdoc = iframeContent;
        }

        function handleConsoleMessage(event) {
            if (event.source !== outputFrame.contentWindow || event.data.source !== 'iframe-console') return;
            const { type, message } = event.data;
            const logEntry = document.createElement('div');
            logEntry.textContent = message;
            logEntry.classList.add(`console-${type}`);
            const prefix = document.createElement('span');
            prefix.textContent = '> ';
            prefix.classList.add('text-gray-500', 'mr-2');
            logEntry.prepend(prefix);
            consoleOutput.appendChild(logEntry);
            consoleOutput.scrollTop = consoleOutput.scrollHeight;
        }

        function updateParticipants(participants) {
            participantsCount.textContent = participants.length;
            participantsList.innerHTML = '';
            participants.forEach(p => {
                const pEl = document.createElement('div');
                pEl.className = 'flex items-center gap-2 bg-gray-700 px-3 py-1 rounded-full';
                const avatar = document.createElement('div');
                avatar.className = 'w-5 h-5 rounded-full';
                avatar.style.backgroundColor = stringToColor(p.uid);
                pEl.appendChild(avatar);
                pEl.append(p.name);
                participantsList.appendChild(pEl);
            });
        }
        
        async function leaveRoom() {
            if (currentRoomId && localUser) {
                const roomRef = doc(db, `artifacts/${appId}/public/data/rooms`, currentRoomId);
                try {
                    const docSnap = await getDoc(roomRef);
                    if (docSnap.exists()) await updateDoc(roomRef, { participants: arrayRemove(localUser) });
                } catch(e) { console.error("Error removing participant:", e)}
            }
            if (unsubscribeRoom) { unsubscribeRoom(); unsubscribeRoom = null; }
            
            currentRoomId = null; localUser = null; window.location.hash = '';
            
            htmlEditor.removeEventListener('input', handleCodeChange);
            cssEditor.removeEventListener('input', handleCodeChange);
            jsEditor.removeEventListener('input', handleCodeChange);
            window.removeEventListener('beforeunload', handleBeforeUnload);
            window.removeEventListener('message', handleConsoleMessage);
            
            consoleOutput.innerHTML = '';
            showView('home');
        }

        function handleBeforeUnload(e) {
            if (currentRoomId && localUser) {
                const roomRef = doc(db, `artifacts/${appId}/public/data/rooms`, currentRoomId);
                updateDoc(roomRef, { participants: arrayRemove(localUser) });
            }
        }
        
        function stringToColor(str) {
            let hash = 0;
            if (!str) return '#ffffff';
            for (let i = 0; i < str.length; i++) hash = str.charCodeAt(i) + ((hash << 5) - hash);
            let color = '#';
            for (let i = 0; i < 3; i++) {
                let value = (hash >> (i * 8)) & 0xFF;
                color += ('00' + value.toString(16)).substr(-2);
            }
            return color;
        }

        signIn();
    </script>
</body>
</html>
