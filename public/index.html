<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Code Collab- Real-time Collaborative IDE</title>
    <script src="https://cdn.tailwindcss.com"></script>
    

   <meta name="description" content="Code Collab is a free, real-time collaborative code editor for pair programming, interviews, and teaching. Share a link and start coding together instantly.">
   <meta name="keywords" content="real-time editor, collaborative coding, pair programming, live code editor, html css js editor, javascript, firebase, open source">
   <meta name="author" content="Abhay557">

   <meta property="og:title" content="Code Collab - Real-time Collaborative Editor">
   <meta property="og:description" content="A free, in-browser tool for pair programming and live code sharing. No sign-up required.">
   <meta property="og:image" content="https://raw.githubusercontent.com/Abhay557/Code-Collab/refs/heads/main/preview.png">
   <meta property="og:url" content="https://www.linkedin.com/posts/abhay557_webdevelopment-opensource-firebase-activity-7385344279336067073-6lwO?utm_source=social_share_send&utm_medium=member_desktop_web&rcm=ACoAAEW4kzUBoGX2tCAhI_tvW_kfJtgr1f106kw">
   <meta property="og:type" content="website">


    
    <!-- CodeMirror for Syntax Highlighting -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.15/codemirror.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.15/theme/dracula.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.15/codemirror.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.15/mode/xml/xml.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.15/mode/javascript/javascript.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.15/mode/css/css.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.15/addon/edit/closetag.min.js"></script>
    
    <!-- JSZip for Downloading Code -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>

    <style>
        /* Custom scrollbar and CodeMirror styling */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #2d3748; }
        ::-webkit-scrollbar-thumb { background: #4a5568; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #718096; }
        
        .CodeMirror { font-family: 'Courier New', Courier, monospace; height: 100%; font-size: 14px; }
        .CodeMirror-gutters { background-color: #282a36 !important; }

        .console-log { color: #e5e7eb; }
        .console-error { color: #f87171; }
        .console-warn { color: #facc15; }
        .console-info { color: #60a5fa; }

        /* Resizer handle styling */
        .resizer {
            background: #4a5568;
            width: 4px;
            cursor: col-resize;
            flex-shrink: 0;
            z-index: 10;
        }
    </style>
</head>
<body class="bg-gray-900 text-white font-sans antialiased">

    <div id="notification" class="hidden fixed top-5 right-5 bg-red-500 text-white py-2 px-4 rounded-lg shadow-lg z-50 transition-opacity duration-300"></div>

    <!-- App Container -->
    <div id="app" class="min-h-screen flex flex-col">

        <!-- Home View -->
        <div id="home-view" class="flex-grow flex items-center justify-center p-4">
            <div class="w-full max-w-md bg-gray-800 rounded-2xl shadow-lg p-8 space-y-6">
                <div>
                    <h1 class="text-4xl font-bold text-center text-indigo-400">Code Collab</h1>
                    <p class="text-center text-gray-400 mt-2">A real-time IDE to code and chat.</p>
                </div>
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                    <button id="create-private-room-btn" class="w-full bg-gray-600 hover:bg-gray-700 text-white font-bold py-3 px-4 rounded-lg transition duration-300">Create Private Room</button>
                    <button id="create-public-room-btn" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-4 rounded-lg transition duration-300">Create Public Room</button>
                </div>
                <div class="relative"><div class="absolute inset-0 flex items-center"><div class="w-full border-t border-gray-600"></div></div><div class="relative flex justify-center text-sm"><span class="px-2 bg-gray-800 text-gray-400">Or</span></div></div>
                <button id="join-random-btn" class="w-full bg-teal-600 hover:bg-teal-700 text-white font-bold py-3 px-4 rounded-lg transition duration-300">Join a Random Public Room</button>
                <div class="relative"><div class="absolute inset-0 flex items-center"><div class="w-full border-t border-gray-600"></div></div><div class="relative flex justify-center text-sm"><span class="px-2 bg-gray-800 text-gray-400">Or</span></div></div>
                <div class="space-y-4">
                    <input type="text" id="room-id-input" placeholder="Enter Room ID" class="w-full bg-gray-700 border-gray-600 text-white px-4 py-3 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500">
                    <button id="join-room-btn" class="w-full bg-gray-600 hover:bg-gray-700 text-white font-bold py-3 px-4 rounded-lg transition duration-300">Join with ID</button>
                    <div class="flex flex-col sm:flex-row items-center justify-center gap-4 pt-4 border-t border-gray-700">
                    <a href="https://github.com/Abhay557/Code-Collab" target="_blank" rel="noopener noreferrer" class="w-full sm:w-auto flex items-center justify-center gap-2 text-white bg-gray-700 hover:bg-gray-600 font-semibold py-2 px-4 rounded-lg transition-colors duration-300">
                        <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24" aria-hidden="true"><path fill-rule="evenodd" d="M12 2C6.477 2 2 6.477 2 12c0 4.418 2.865 8.168 6.839 9.492.5.092.682-.217.682-.482 0-.237-.009-.868-.014-1.703-2.782.605-3.369-1.343-3.369-1.343-.454-1.158-1.11-1.466-1.11-1.466-.908-.62.069-.608.069-.608 1.003.07 1.531 1.032 1.531 1.032.892 1.53 2.341 1.088 2.91.832.092-.647.35-1.088.636-1.338-2.22-.253-4.555-1.113-4.555-4.951 0-1.093.39-1.988 1.031-2.688-.103-.253-.446-1.272.098-2.65 0 0 .84-.27 2.75 1.026A9.564 9.564 0 0112 6.844c.85.004 1.705.115 2.504.337 1.909-1.296 2.747-1.027 2.747-1.027.546 1.379.203 2.398.1 2.651.64.7 1.03 1.595 1.03 2.688 0 3.848-2.338 4.695-4.566 4.942.359.308.678.92.678 1.855 0 1.338-.012 2.419-.012 2.747 0 .268.18.58.688.482A10.001 10.001 0 0022 12c0-5.523-4.477-10-10-10z" clip-rule="evenodd" /></svg>
                        GitHub
                    </a>
                    <a href="https://discord.gg/f2vvuz3ZEw" target="_blank" rel="noopener noreferrer" class="w-full sm:w-auto flex items-center justify-center gap-2 text-white bg-gray-700 hover:bg-gray-600 font-semibold py-2 px-4 rounded-lg transition-colors duration-300">
                        <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 16 16" aria-hidden="true">
                            <path d="M13.545 2.907a13.227 13.227 0 0 0-3.257-1.011.05.05 0 0 0-.052.025c-.141.25-.297.577-.406.833a12.19 12.19 0 0 0-3.658 0 8.258 8.258 0 0 0-.412-.833.051.051 0 0 0-.052-.025c-1.125.194-2.22.534-3.257 1.011a.041.041 0 0 0-.021.018C.356 6.024-.213 9.047.066 12.032c.001.014.01.028.021.037a13.276 13.276 0 0 0 3.995 2.02.05.05 0 0 0 .056-.019c.308-.42.582-.863.818-1.329a.05.05 0 0 0-.01-.059.051.051 0 0 0-.018-.011 8.875 8.875 0 0 1-1.248-.595.05.05 0 0 1-.02-.066.051.051 0 0 1 .015-.019c.084-.063.168-.129.248-.195a.05.05 0 0 1 .051-.007c2.619 1.165 5.48 1.165 8.1 0a.05.05 0 0 1 .053.007c.08.066.164.132.248.195a.051.051 0 0 1 .015.019.05.05 0 0 1-.02.066 8.875 8.875 0 0 1-1.248.595.05.05 0 0 0-.01.059c.236.466.51.899.818 1.329a.05.05 0 0 0 .056.019 13.235 13.235 0 0 0 4.001-2.02.049.049 0 0 0 .021-.037c.276-2.986-.42-6.008-1.99-9.125a.043.043 0 0 0-.02-.019Zm-8.198 7.307c-.789 0-1.438-.724-1.438-1.612 0-.889.637-1.613 1.438-1.613.807 0 1.45.73 1.438 1.613 0 .888-.637 1.612-1.438 1.612Zm5.316 0c-.788 0-1.438-.724-1.438-1.612 0-.889.637-1.613 1.438-1.613.807 0 1.451.73 1.438 1.613 0 .888-.631 1.612-1.438 1.612Z"/>
                        </svg>
                        Discord
                    </a>
                </div>
            </div>
        </div>

        <!-- Editor View -->
        <div id="editor-view" class="hidden flex-grow flex flex-col h-screen">
            <header class="bg-gray-800 p-3 flex items-center justify-between shadow-md z-10 flex-shrink-0">
                <div class="flex items-center gap-4">
                    <h1 class="text-2xl font-bold text-indigo-400">Code Collab</h1>
                    <div class="text-gray-400"><span class="font-mono bg-gray-700 px-3 py-1 rounded-md text-sm">Room ID: <span id="room-id-display" class="font-bold text-indigo-300"></span></span></div>
                </div>
                <div class="flex items-center gap-4">
                    <div id="participants-list" class="flex items-center gap-2 text-sm text-gray-300"></div>
                    <button id="toggle-chat-btn" class="flex items-center gap-2 bg-gray-700 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded-lg transition duration-300 text-sm">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M18 5v8a2 2 0 01-2 2h-5l-5 4v-4H4a2 2 0 01-2-2V5a2 2 0 012-2h12a2 2 0 012 2zM7 8H5v2h2V8zm2 0h2v2H9V8zm6 0h-2v2h2V8z" clip-rule="evenodd" /></svg>
                        Chat
                    </button>
                    <button id="leave-room-btn" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg transition duration-300 text-sm">Leave Room</button>
                </div>
            </header>

            <div id="content-wrapper" class="flex-grow flex flex-row gap-2 p-2 overflow-hidden">
                <div id="editor-panel" class="flex flex-col gap-2" style="flex-basis: 50%;">
                    <div class="flex flex-col bg-gray-800 rounded-lg overflow-hidden flex-1"><div class="bg-gray-900 px-4 py-2 text-sm font-semibold text-gray-300">HTML</div><textarea id="html-editor"></textarea></div>
                    <div class="flex flex-col bg-gray-800 rounded-lg overflow-hidden flex-1"><div class="bg-gray-900 px-4 py-2 text-sm font-semibold text-gray-300">CSS</div><textarea id="css-editor"></textarea></div>
                    <div class="flex flex-col bg-gray-800 rounded-lg overflow-hidden flex-1"><div class="bg-gray-900 px-4 py-2 text-sm font-semibold text-gray-300">JavaScript</div><textarea id="js-editor"></textarea></div>
                    <div class="flex flex-col bg-gray-800 rounded-lg overflow-hidden flex-1"><div class="bg-gray-900 px-4 py-2 text-sm font-semibold text-gray-300 flex justify-between items-center"><span>Console</span><button id="clear-console-btn" class="text-xs bg-gray-700 hover:bg-gray-600 px-2 py-1 rounded">Clear</button></div><div id="console-output" class="p-2 overflow-y-auto text-sm font-mono space-y-1 w-full flex-grow"></div></div>
                </div>
                
                <div id="resizer" class="resizer"></div>
                
                <div id="output-panel" class="relative bg-white rounded-lg overflow-hidden" style="flex-basis: 50%;">
                    <iframe id="output-frame" class="w-full h-full border-0"></iframe>
                    <div class="absolute bottom-4 right-4 flex gap-2">
                        <button id="download-btn" title="Download Code" class="bg-gray-700 text-white hover:bg-indigo-600 rounded-full p-3 shadow-lg transition-colors"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" /></svg></button>
                        <button id="popout-btn" title="Open in New Window" class="bg-gray-700 text-white hover:bg-indigo-600 rounded-full p-3 shadow-lg transition-colors"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14" /></svg></button>
                    </div>
                </div>

                <div id="chat-panel" class="flex-col bg-gray-800 rounded-lg overflow-hidden transition-all duration-300" style="flex-basis: 0; display: none;">
                    <div class="bg-gray-900 px-4 py-2 text-sm font-semibold text-gray-300 flex-shrink-0">Room Chat</div>
                    <div id="chat-messages" class="flex-grow p-4 overflow-y-auto space-y-4"></div>
                    <form id="chat-form" class="p-2 border-t border-gray-700"><div class="flex gap-2"><input type="text" id="chat-input" placeholder="Type a message..." class="flex-grow bg-gray-700 border-gray-600 text-white px-3 py-2 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500"><button type="submit" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold p-2 rounded-lg"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path d="M10.894 2.553a1 1 0 00-1.788 0l-7 14a1 1 0 001.169 1.409l5-1.428A1 1 0 009.894 15V4.106A1 1 0 0010.894 2.553z" /></svg></button></div></form>
                </div>
            </div>
        </div>

        <div id="name-modal" class="hidden fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50"><div class="bg-gray-800 rounded-2xl shadow-lg p-8 w-full max-w-sm space-y-4"><h2 id="modal-title" class="text-2xl font-bold text-center">Enter Your Name</h2><input type="text" id="name-input" placeholder="Your Name" class="w-full bg-gray-700 border-gray-600 text-white px-4 py-3 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500"><div class="flex gap-4"><button id="modal-cancel" class="w-full bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-lg">Cancel</button><button id="modal-confirm" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-lg">Confirm</button></div></div></div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, updateDoc, onSnapshot, arrayUnion, arrayRemove, serverTimestamp, collection, addDoc, query, where, getDocs, orderBy } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

         const firebaseConfig = {
  // add yours
};

const appId = 'default-collab-editor'; // You can leave this as is.
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        const dom = { 
            home: document.getElementById('home-view'), 
            editor: document.getElementById('editor-view'), 
            createPrivateBtn: document.getElementById('create-private-room-btn'), 
            createPublicBtn: document.getElementById('create-public-room-btn'), 
            joinRandomBtn: document.getElementById('join-random-btn'), 
            joinBtn: document.getElementById('join-room-btn'), 
            roomIdInput: document.getElementById('room-id-input'), 
            roomIdDisplay: document.getElementById('room-id-display'), 
            participants: document.getElementById('participants-list'), 
            leaveBtn: document.getElementById('leave-room-btn'), 
            output: document.getElementById('output-frame'), 
            notification: document.getElementById('notification'), 
            console: document.getElementById('console-output'), 
            clearConsoleBtn: document.getElementById('clear-console-btn'), 
            modal: document.getElementById('name-modal'), 
            modalTitle: document.getElementById('modal-title'), 
            nameInput: document.getElementById('name-input'), 
            modalConfirm: document.getElementById('modal-confirm'), 
            modalCancel: document.getElementById('modal-cancel'), 
            chatPanel: document.getElementById('chat-panel'), 
            chatMessages: document.getElementById('chat-messages'), 
            chatForm: document.getElementById('chat-form'), 
            chatInput: document.getElementById('chat-input'), 
            toggleChatBtn: document.getElementById('toggle-chat-btn'), 
            editorPanel: document.getElementById('editor-panel'), 
            outputPanel: document.getElementById('output-panel'), 
            resizer: document.getElementById('resizer'), 
            downloadBtn: document.getElementById('download-btn'), 
            popoutBtn: document.getElementById('popout-btn'), 
            contentWrapper: document.getElementById('content-wrapper') 
        };
        let currentUser, currentRoomId, localUser, debounceTimer, unsubscribeRoom, unsubscribeChat, htmlEditor, cssEditor, jsEditor;
        let isChatOpen = false;

        onAuthStateChanged(auth, user => {
            if (user) {
                currentUser = user;
                initializeAppLogic();
            } else {
                signIn();
            }
        });

        async function signIn() {
            try {
                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                    await signInWithCustomToken(auth, __initial_auth_token);
                } else {
                    await signInAnonymously(auth);
                }
            } catch (e) {
                console.error("Authentication failed:", e);
                showNotification("Could not connect to the service.");
            }
        }

        function showView(viewName) {
            dom.home.style.display = viewName === 'home' ? 'flex' : 'none';
            dom.editor.style.display = viewName === 'editor' ? 'flex' : 'none';
        }

        function showNotification(message, type = 'error') {
            dom.notification.textContent = message;
            dom.notification.className = `fixed top-5 right-5 text-white py-2 px-4 rounded-lg shadow-lg z-50 bg-${type === 'error' ? 'red' : (type === 'info' ? 'blue' : 'green')}-500`;
            dom.notification.style.display = 'block';
            setTimeout(() => { dom.notification.style.display = 'none'; }, 3000);
        }

        function askForName(title) {
            return new Promise(resolve => {
                dom.modalTitle.textContent = title;
                dom.nameInput.value = '';
                dom.modal.style.display = 'flex';
                
                const onConfirm = () => {
                    if (dom.nameInput.value.trim()) {
                        cleanup();
                        resolve(dom.nameInput.value.trim());
                    }
                };
                
                const onCancel = () => {
                    cleanup();
                    resolve(null);
                };

                const onKeypress = e => {
                    if (e.key === 'Enter') {
                        onConfirm();
                    }
                };

                const cleanup = () => {
                    dom.modal.style.display = 'none';
                    dom.modalConfirm.removeEventListener('click', onConfirm);
                    dom.modalCancel.removeEventListener('click', onCancel);
                    dom.nameInput.removeEventListener('keypress', onKeypress);
                };

                dom.modalConfirm.addEventListener('click', onConfirm);
                dom.modalCancel.addEventListener('click', onCancel);
                dom.nameInput.addEventListener('keypress', onKeypress);
                dom.nameInput.focus();
            });
        }

        function initializeAppLogic() {
            const roomId = window.location.hash.substring(1);
            if (roomId) {
                handleJoinRoom(roomId);
            } else {
                showView('home');
            }
            window.addEventListener('hashchange', () => {
                if (!window.location.hash.substring(1)) {
                    leaveRoom();
                }
            });
            initResizing();
        }
        
        const handleCreateRoom = async (isPublic) => {
            if (!currentUser) return showNotification("Connecting...");
            const name = await askForName(`Enter Your Name to Create ${isPublic ? 'Public' : 'Private'} Room`);
            if (!name) return;
            
            localUser = { uid: currentUser.uid, name };
            const newRoomId = Math.random().toString(36).substring(2, 9);
            const roomRef = doc(db, `artifacts/${appId}/public/data/rooms`, newRoomId);

            try {
                await setDoc(roomRef, {
                    html: `<h1>Welcome!</h1>\n<p>Start coding and see your changes live.</p>`,
                    css: `body {\n  font-family: sans-serif;\n  padding: 1em;\n}`,
                    js: `console.log("Hello from your new room!");`,
                    participants: [localUser],
                    createdAt: serverTimestamp(),
                    isPublic
                });
                window.location.hash = newRoomId;
                enterEditor(newRoomId, roomRef);
            } catch (e) {
                console.error("Create room error:", e);
                showNotification("Could not create room.");
            }
        };
        
        dom.createPrivateBtn.addEventListener('click', () => handleCreateRoom(false));
        dom.createPublicBtn.addEventListener('click', () => handleCreateRoom(true));
        
        dom.joinRandomBtn.addEventListener('click', async () => {
            if (!currentUser) return showNotification("Connecting...");
            showNotification("Finding a public room...", "info");
            
            const roomsRef = collection(db, `artifacts/${appId}/public/data/rooms`);
            const q = query(roomsRef, where("isPublic", "==", true));
            
            try {
                const querySnapshot = await getDocs(q);
                const availableRooms = [];
                querySnapshot.forEach(doc => {
                    if (doc.data().participants.length < 6) { // Max 6 participants
                        availableRooms.push(doc.id);
                    }
                });

                if (availableRooms.length > 0) {
                    const randomRoomId = availableRooms[Math.floor(Math.random() * availableRooms.length)];
                    handleJoinRoom(randomRoomId);
                } else {
                    showNotification("No public rooms available. Why not create one?", "info");
                }
            } catch (error) {
                console.error("Error finding random room:", error);
                showNotification("Could not find a room. Please try again.");
            }
        });

        dom.joinBtn.addEventListener('click', () => {
            const roomId = dom.roomIdInput.value.trim();
            if (roomId) handleJoinRoom(roomId);
            else showNotification("Please enter a Room ID.");
        });

        async function handleJoinRoom(roomId) {
            if (!currentUser) return showNotification("Connecting...");
            const roomRef = doc(db, `artifacts/${appId}/public/data/rooms`, roomId);
            try {
                const roomSnap = await getDoc(roomRef);
                if (!roomSnap.exists()) {
                    showNotification("Room not found!");
                    window.location.hash = '';
                    return;
                }
                const name = await askForName('Enter Your Name to Join');
                if (!name) {
                    window.location.hash = '';
                    return;
                }
                localUser = { uid: currentUser.uid, name: name };
                await updateDoc(roomRef, { participants: arrayUnion(localUser) });
                window.location.hash = roomId;
                enterEditor(roomId, roomRef);
            } catch (e) {
                console.error("Join room error:", e);
                showNotification("Could not join room.");
                window.location.hash = '';
            }
        }

        function initializeEditors() {
            const opts = { theme: 'dracula', lineNumbers: true };
            htmlEditor = CodeMirror.fromTextArea(document.getElementById('html-editor'), { ...opts, mode: 'xml', autoCloseTags: true });
            cssEditor = CodeMirror.fromTextArea(document.getElementById('css-editor'), { ...opts, mode: 'css' });
            jsEditor = CodeMirror.fromTextArea(document.getElementById('js-editor'), { ...opts, mode: 'javascript' });
        }

        function enterEditor(roomId, roomRef) {
            currentRoomId = roomId;
            showView('editor');
            dom.roomIdDisplay.textContent = roomId;
            if (!htmlEditor) initializeEditors();

            unsubscribeRoom = onSnapshot(roomRef, d => {
                if (d.exists()) {
                    const data = d.data();
                    if (!htmlEditor.hasFocus()) htmlEditor.setValue(data.html);
                    if (!cssEditor.hasFocus()) cssEditor.setValue(data.css);
                    if (!jsEditor.hasFocus()) jsEditor.setValue(data.js);
                    updateIframe();
                    updateParticipants(data.participants);
                } else {
                    showNotification("Room was closed.", "info");
                    leaveRoom();
                }
            });
            
            const msgRef = collection(db, `artifacts/${appId}/public/data/rooms`, roomId, 'messages');
            unsubscribeChat = onSnapshot(query(msgRef, orderBy("timestamp")), s => {
                dom.chatMessages.innerHTML = '';
                s.forEach(d => renderMessage(d.data()));
                dom.chatMessages.scrollTop = dom.chatMessages.scrollHeight;
            });
            
            htmlEditor.on('change', () => handleCodeChange('html', htmlEditor.getValue()));
            cssEditor.on('change', () => handleCodeChange('css', cssEditor.getValue()));
            jsEditor.on('change', () => handleCodeChange('js', jsEditor.getValue()));
            
            dom.chatForm.addEventListener('submit', handleSendMessage);
            dom.leaveBtn.addEventListener('click', leaveRoom);
            dom.clearConsoleBtn.addEventListener('click', () => dom.console.innerHTML = '');
            dom.toggleChatBtn.addEventListener('click', toggleChat);
            dom.downloadBtn.addEventListener('click', handleDownload);
            dom.popoutBtn.addEventListener('click', handlePopout);
            
            window.addEventListener('message', handleConsoleMessage);
            window.addEventListener('beforeunload', handleBeforeUnload);
        }

        const handleSendMessage = async (e) => {
            e.preventDefault();
            const text = dom.chatInput.value.trim();
            if (!text) return;
            try {
                const messagesRef = collection(db, `artifacts/${appId}/public/data/rooms`, currentRoomId, 'messages');
                await addDoc(messagesRef, {
                    text,
                    senderName: localUser.name,
                    senderUid: localUser.uid,
                    timestamp: serverTimestamp()
                });
                dom.chatInput.value = '';
            } catch (e) {
                console.error("Message send error:", e);
                showNotification("Could not send message.");
            }
        };

        function renderMessage(data) {
            const isMe = data.senderUid === currentUser.uid;
            const msgContainer = document.createElement('div');
            msgContainer.className = `flex flex-col ${isMe ? 'items-end' : 'items-start'}`;
            const bubble = document.createElement('div');
            bubble.className = `px-3 py-2 rounded-lg max-w-xs ${isMe ? 'bg-indigo-600' : 'bg-gray-600'}`;
            if (!isMe) {
                const sender = document.createElement('div');
                sender.className = 'text-xs font-bold text-indigo-300';
                sender.textContent = data.senderName;
                bubble.appendChild(sender);
            }
            const msgText = document.createElement('p');
            msgText.className = 'text-sm break-words';
            msgText.textContent = data.text;
            bubble.appendChild(msgText);
            msgContainer.appendChild(bubble);
            dom.chatMessages.appendChild(msgContainer);
        }

        function handleCodeChange(lang, value) {
            clearTimeout(debounceTimer);
            debounceTimer = setTimeout(() => {
                if (currentRoomId) {
                    const roomRef = doc(db, `artifacts/${appId}/public/data/rooms`, currentRoomId);
                    updateDoc(roomRef, { [lang]: value });
                }
            }, 500);
        }

        function updateIframe() {
            if (!htmlEditor || !cssEditor || !jsEditor) return;
            const consoleScript = `<script>const f=a=>{if(a instanceof Error)return a.stack||a.message;if(typeof a==='object'&&a!==null)try{return JSON.stringify(a)}catch(e){return'[Unserializable]'}return String(a)};const o=(m,t)=>{const c=console[m];console[m]=(...a)=>{window.parent.postMessage({s:'iframe-console',t,m:a.map(f).join(' ')},'*');c.apply(console,a)}};['log','error','warn','info'].forEach(m=>o(m,m));window.addEventListener('error',e=>window.parent.postMessage({s:'iframe-console',t:'error',m:e.message},'*'));<\/script>`;
            const content = `<html><head><style>${cssEditor.getValue()}<\/style>${consoleScript}<\/head><body>${htmlEditor.getValue()}<script>try{${jsEditor.getValue()}}catch(e){console.error(e);}<\/script><\/body><\/html>`;
            dom.output.srcdoc = content;
        }

        function handleConsoleMessage({ source, data }) {
            if (source !== dom.output.contentWindow || data.s !== 'iframe-console') return;
            const logEntry = document.createElement('div');
            logEntry.textContent = data.m;
            logEntry.className = `console-${data.t}`;
            logEntry.innerHTML = `<span class="text-gray-500 mr-2">&gt;</span>` + logEntry.innerHTML;
            dom.console.appendChild(logEntry);
            dom.console.scrollTop = dom.console.scrollHeight;
        }

        function updateParticipants(participants) {
            dom.participants.innerHTML = '';
            participants.forEach(p => {
                const pEl = document.createElement('div');
                pEl.className = 'flex items-center gap-2 bg-gray-700 px-3 py-1 rounded-full';
                const avatar = document.createElement('div');
                avatar.className = 'w-5 h-5 rounded-full';
                avatar.style.backgroundColor = stringToColor(p.uid);
                pEl.append(avatar, p.name);
                dom.participants.appendChild(pEl);
            });
        }

        function toggleChat() {
            isChatOpen = !isChatOpen;
            dom.chatPanel.style.display = isChatOpen ? 'flex' : 'none';
            dom.resizer.style.display = isChatOpen ? 'none' : 'block';

            if (isChatOpen) {
                // Rearrange for chat view
                dom.contentWrapper.insertBefore(dom.chatPanel, dom.resizer.nextSibling); 
                dom.editorPanel.style.flexBasis = '50%';
                dom.outputPanel.style.flexBasis = '50%';
                dom.chatPanel.style.flexBasis = '300px'; 
                dom.resizer.style.display = 'none'; 
            } else {
                // Restore normal view
                dom.editorPanel.style.flexBasis = '50%';
                dom.outputPanel.style.flexBasis = '50%';
                dom.chatPanel.style.flexBasis = '0px';
                dom.resizer.style.display = 'block';
            }
            refreshEditors();
        }

        function initResizing() {
            let isResizing = false;
            dom.resizer.addEventListener('mousedown', (e) => {
                isResizing = true;
                document.body.style.cursor = 'col-resize';
            });
            document.addEventListener('mousemove', (e) => {
                if (!isResizing || isChatOpen) return;
                const wrapper = dom.contentWrapper.getBoundingClientRect();
                const editorWidth = e.clientX - wrapper.left;
                const outputWidth = wrapper.width - editorWidth - dom.resizer.offsetWidth;
                if (editorWidth > 200 && outputWidth > 200) { // minimum panel width
                    dom.editorPanel.style.flexBasis = `${editorWidth}px`;
                    dom.outputPanel.style.flexBasis = `${outputWidth}px`;
                }
            });
            document.addEventListener('mouseup', () => {
                isResizing = false;
                document.body.style.cursor = 'default';
                refreshEditors();
            });
        }

        async function handleDownload() {
            const zip = new JSZip();
            zip.file("index.html", `<!DOCTYPE html>\n<html>\n<head>\n  <link rel="stylesheet" href="style.css">\n</head>\n<body>\n${htmlEditor.getValue()}\n  <script src="script.js"><\/script>\n</body>\n</html>`);
            zip.file("style.css", cssEditor.getValue());
            zip.file("script.js", jsEditor.getValue());
            const content = await zip.generateAsync({ type: "blob" });
            const link = document.createElement("a");
            link.href = URL.createObjectURL(content);
            link.download = "code-collab-project.zip";
            link.click();
            URL.revokeObjectURL(link.href);
        }

        function handlePopout() {
            const content = `<html><head><title>Output</title><style>${cssEditor.getValue()}<\/style></head><body>${htmlEditor.getValue()}<script>${jsEditor.getValue()}<\/script></body></html>`;
            const blob = new Blob([content], { type: 'text/html' });
            const url = URL.createObjectURL(blob);
            window.open(url, '_blank');
        }
        
        function refreshEditors() {
            setTimeout(() => {
                if (htmlEditor) htmlEditor.refresh();
                if (cssEditor) cssEditor.refresh();
                if (jsEditor) jsEditor.refresh();
            }, 10);
        }

        async function leaveRoom() {
            if (currentRoomId && localUser) {
                try {
                    const roomRef = doc(db, `artifacts/${appId}/public/data/rooms`, currentRoomId);
                    await updateDoc(roomRef, { participants: arrayRemove(localUser) });
                } catch (e) {
                    console.error("Error removing participant:", e);
                }
            }
            if (unsubscribeRoom) unsubscribeRoom();
            if (unsubscribeChat) unsubscribeChat();
            unsubscribeRoom = unsubscribeChat = null;
            currentRoomId = localUser = null;
            window.location.hash = '';
            window.removeEventListener('beforeunload', handleBeforeUnload);
            window.removeEventListener('message', handleConsoleMessage);
            showView('home');
        }

        function handleBeforeUnload() {
            if (currentRoomId && localUser) {
                leaveRoom();
            }
        }
        
        function stringToColor(s) {
            let h = 0;
            if (!s) return '#ffffff';
            for (let i = 0; i < s.length; i++) h = s.charCodeAt(i) + ((h << 5) - h);
            let c = '#';
            for (let i = 0; i < 3; i++) c += ('00' + ((h >> (i * 8)) & 0xFF).toString(16)).substr(-2);
            return c;
        }

        signIn();
    </script>
</body>
</html>


